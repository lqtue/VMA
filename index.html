<!doctype html>
<html lang="vi"> <!-- Default language -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- These CSS files are placeholders. If you have them, they should be in a 'css' folder. -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <!-- Using a CDN for Font Awesome for reliability -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* Base styles */
        html, body {
            margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; overflow: hidden;
        }
        #map { position: fixed; top: 50px; /* Adjusted for top bar */ left: 0; right: 0; bottom: 0; background-color: #f0f0f0; }

        /* --- Top Bar --- */
        #top-bar {
            position: fixed; top: 0; left: 0; right: 0; height: 50px;
            background: #4A3A29; color: #E9E1D4;
            z-index: 1500; display: flex;
            align-items: center; padding: 0 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #top-bar .logo-title { display: flex; align-items: center; gap: 10px; }
        #top-bar .logo-title img { height: 30px; border-radius: 4px; }
        #top-bar .logo-title h1 { font-size: 1.2em; margin: 0; white-space: nowrap; font-weight: 600; }
        .top-bar-nav { margin-left: auto; display: flex; align-items: center; gap: 15px; }
        .search-container { position: relative; }
        .search-container input {
            background-color: #3D2F22; border: 1px solid #6E5A44;
            color: #E9E1D4; border-radius: 5px; padding: 5px 10px 5px 30px;
            font-size: 0.9em; transition: width 0.3s ease; width: 150px;
        }
        .search-container input::placeholder { color: #BFB5A6; }
        .search-container input:focus { width: 200px; outline: none; border-color: #E9E1D4; }
        .search-container .fa-search {
            position: absolute; left: 10px; top: 50%;
            transform: translateY(-50%); color: #BFB5A6;
        }
        #search-results-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #3D2F22;
            border: 1px solid #6E5A44;
            border-top: none;
            border-radius: 0 0 5px 5px;
            z-index: 1501;
            max-height: 300px;
            overflow-y: auto;
            display: none; /* Initially hidden */
        }
        .search-result-item {
            padding: 8px 12px;
            color: #E9E1D4;
            cursor: pointer;
            font-size: 0.9em;
            border-bottom: 1px solid #4A3A29;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background-color: #6E5A44; }
        .top-bar-nav button {
            background: none; border: none; color: #E9E1D4;
            font-size: 1em; cursor: pointer; display: flex;
            align-items: center; gap: 8px; padding: 5px;
            transition: color 0.2s;
        }
        .top-bar-nav button:hover { color: #FFFFFF; }
        .top-bar-nav button .nav-text {
             font-size: 0.9em;
        }
        /* --- Top Right Floating Controls --- */
        #opacity-control-container {
            position: fixed;
            top: 65px; /* 50px for top bar + 15px margin */
            right: 15px;
            z-index: 1080; /* Above map, below popups */
            background-color: rgba(74, 58, 41, 0.95);
            backdrop-filter: blur(5px);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
        }
        #opacity-control-container button {
            background: #E9E1D4; color: #4A3A29; border: none; width: 35px; height: 35px;
            border-radius: 5px; font-size: 1.2em; cursor: pointer; display: flex;
            align-items: center; justify-content: center; transition: background-color 0.2s;
        }
        #opacity-control-container button:hover { background: #BFB5A6; }
        #opacity-label {
            color: #E9E1D4;
            padding: 0 2px 0 10px; /* Adjust padding for new order */
            font-size: 0.9em;
            white-space: nowrap;
        }
        .lang-text { font-size: 0.9em; } .lang-short { display: none; }

        /* --- HIDE Default Leaflet Zoom --- */
        .leaflet-control-zoom { display: none !important; }

        /* --- Narrative Controls (INSIDE Info Box) --- */
        #narrative-controls {
            background: rgba(74, 58, 41, 0.9); padding: 8px 10px;
            border-top: 1px solid #4A3A29; box-shadow: none; display: none;
            align-items: center; justify-content: space-between; flex-shrink: 0;
            margin-top: auto;
        }
        body.narrative-mode #info-box #narrative-controls { display: flex; }
        #narrative-controls button { background: #E9E1D4; color: #4A3A29; border: none; padding: 5px 10px; margin: 0 5px; cursor: pointer; border-radius: 4px; font-size: 12px; }
        #narrative-controls button:disabled { background: #888; color: #ccc; cursor: default; }
        #narrative-controls button:hover:not(:disabled) { background: #BFB5A6; }
        #narrative-progress { font-size: 12px; color: #E9E1D4; text-align: center; flex-grow: 1; margin: 0 5px; }

        /* --- About Popup --- */
        #about-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.65); z-index: 1999; display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        #about-overlay.visible { display: block; opacity: 1; }
        #about-popup {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -60%); width: 90%; max-width: 500px;
            background-color: #4A3A29; color: #E9E1D4; padding: 25px 30px;
            border-radius: 8px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            z-index: 2000; display: none; text-align: left;
            line-height: 1.6; opacity: 0; max-height: 80vh;
            transition: opacity 0.3s ease-in-out 0.1s, transform 0.3s ease-in-out 0.1s;
            flex-direction: column;
        }
        #about-popup.visible { display: flex; opacity: 1; transform: translate(-50%, -50%); }
        #about-popup h3 { margin-top: 0; margin-bottom: 15px; color: #FFFFFF; text-align: center; font-size: 1.4em; }
        #about-popup p { margin-bottom: 12px; font-size: 0.95em; }

        .popup-close-btn {
            position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 28px; line-height: 1; color: #BFB5A6; cursor: pointer; padding: 0 5px; transition: color 0.2s;
        }
        .popup-close-btn:hover { color: #FFFFFF; }

        /* --- Bottom Time Controls --- */

         #bottom-controls {
             position: fixed; bottom: 0; left: 0; right: 0;
             background-color: rgba(74, 58, 41, 0.95);
             backdrop-filter: blur(5px);
             color: #E9E1D4;
             padding: 5px 5px;
             z-index: 1070;
             box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
             height: auto;
             min-height: 70px; /* Made smaller */
             box-sizing: border-box;
             display: flex;
             flex-direction: column;
             gap: 5px; /* Spacing between card and dots */
             transition: min-height 0.3s ease-in-out;
         }
         .timeline-main {
             display: flex;
             align-items: center;
             gap: 15px;
             width: 100%;
         }
         .timeline-nav-btn {
             background: #E9E1D4;
             color: #4A3A29;
             border: none;
             width: 35px;
             height: 35px;
             border-radius: 50%;
             font-size: 1.2em;
             cursor: pointer;
             flex-shrink: 0;
             display: flex;
             align-items: center;
             justify-content: center;
             transition: background-color 0.2s;
         }
         .timeline-nav-btn:hover:not(:disabled) { background: #BFB5A6; }
         .timeline-nav-btn:disabled { background: #6E5A44; color: #8f806d; cursor: default; }
         #timeline-card-display {
             flex-grow: 1;
             min-height: 60px; /* Adjust base height */
             display: flex;
             justify-content: center;
             align-items: center;
         }
         .map-card {
             background-color: transparent;
             border: none;
             border-radius: 0;
             padding: 0 10px; /* Add some horizontal padding */
             box-sizing: border-box;
             cursor: default;
             transition: max-width 0.3s ease-in-out;
             height: auto;
             width: 100%;
             max-width: 450px; /* Give card a max-width */
             overflow: visible;
         }
         #bottom-controls.expanded .map-card {
             max-width: 700px; /* Wider when expanded */
         }
         .map-card-header { display: flex; justify-content: center; text-align: center; font-weight: bold; margin-bottom: 5px; font-size: 1.1em; }
         .map-card-title { font-size: 1em; white-space: normal; overflow: visible; text-overflow: clip; }
         .map-card-summary {
             font-size: 0.9em; color: #BFB5A6; line-height: 1.4; text-align: center;
             /* --- Styles for expand/collapse --- */
             max-height: 0;
             overflow: hidden;
             opacity: 0;
             transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out 0.1s;
             padding-top: 5px;
             box-sizing: border-box;
         }
         #bottom-controls.expanded .map-card-summary {
             max-height: 15vh; /* Use vh for responsive height */
             opacity: 1;
             overflow-y: auto; /* Add scroll if content exceeds max-height */
             scrollbar-width: thin;
             scrollbar-color: #8f806d #4A3A29;
         }
         #bottom-controls.expanded .map-card-summary::-webkit-scrollbar { width: 5px; }
         #bottom-controls.expanded .map-card-summary::-webkit-scrollbar-thumb { background: #8f806d; border-radius: 3px; }
         #bottom-controls.expanded .map-card-summary::-webkit-scrollbar-track {
             background: rgba(0,0,0,0.1);
         }
         #timeline-dots {
             padding: 5px 15px 0 15px; width: 100%; box-sizing: border-box;
             overflow-x: auto; overflow-y: hidden; display: flex; gap: 15px;
             scrollbar-width: thin; scrollbar-color: #8f806d #4A3A29;
             justify-content: center;
         }
         #timeline-dots::-webkit-scrollbar { height: 4px; }
         #timeline-dots::-webkit-scrollbar-thumb { background: #8f806d; border-radius: 2px; }
         #timeline-dots::-webkit-scrollbar-track { background: #4A3A29; }
         .dot-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 0 5px 5px 5px; flex-shrink: 0; }
         .timeline-dot {
             width: 10px; height: 10px;
             border-radius: 50%; background: #6E5A44; margin: 0;
             transition: background-color 0.3s, transform 0.3s;
         }
         .dot-item.active .timeline-dot {
             background-color: #E9E1D4;
             transform: scale(1.3);
         }
         .dot-year { font-size: 11px; color: #BFB5A6; margin-top: 6px; transition: color 0.3s; }
         .dot-item.active .dot-year {
             color: #FFFFFF;
             font-weight: bold;
         }

        /* --- Responsive Adjustments --- */
        @media screen and (max-width: 768px) {
            #top-bar .logo-title h1 { display: none; }
            .top-bar-nav .nav-text { display: none; }
            .lang-full { display: none; }
            .lang-short { display: inline; }
            .map-card { flex: 0 0 240px; } /* Smaller cards on mobile */
        }
        @media screen and (max-width: 480px) {
            .search-container input { width: 100px; }
            .search-container input:focus { width: 120px; }
            #instruction-popup, #about-popup { padding: 20px 15px; }
            #instruction-popup h3, #about-popup h3 { font-size: 1.2em; }
            #instruction-popup p, #about-popup p { font-size: 0.9em; }
        }
    </style>
    <title>Saigon - HCMC Historical Maps</title>
</head>
<body class="discovery-mode"> <!-- Default to discovery mode -->
    <!-- Top Bar -->
    <div id="top-bar">
        <div class="logo-title">
             <img src="https://placehold.co/100x100/4A3A29/E9E1D4?text=LOGO" alt="Logo" onerror="this.onerror=null;this.src='https://placehold.co/100x100/4A3A29/E9E1D4?text=LOGO';">
            <h1 data-i18n-key="welcomeTitle">Saigon - HCMC Historical Maps</h1>
        </div>
        <div class="top-bar-nav">
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="Search for a location in HCMC...">
                <div id="search-results-container"></div>
            </div>
            <button id="top-bar-language-btn" title="Switch Language">
                <i class="fas fa-globe"></i>
                <span class="lang-text"><span class="lang-full" data-i18n-key="switchLangBtn">English</span><span class="lang-short" data-i18n-key="switchLangBtnShort">EN</span></span>
            </button>
            <button id="about-btn" title="About"><i class="fas fa-info-circle"></i> <span class="nav-text">About</span></button>
        </div>
    </div>

    <!-- Fullscreen Map -->
    <div id="map"></div>

    <!-- Top Right Controls -->
    <div id="opacity-control-container">
        <span id="opacity-label">Opacity: 100%</span>
        <button id="opacity-btn" title="Cycle Opacity"><i class="fas fa-adjust"></i></button>
    </div>

    <!-- About Popup -->
    <div id="about-overlay"></div>
    <div id="about-popup">
        <button id="close-about-btn" class="popup-close-btn" title="Close About">×</button>
        <h3>About This Project</h3>
        <p>This interactive map application allows the exploration of historical maps of Saigon - Ho Chi Minh City.</p>
        <p>Developed by [Your Name/Organization]. Data sourced from [Your Data Sources].</p>
        <p>This is a demonstration project and should not be used for navigational purposes.</p>
    </div>

    <!-- Bottom Controls Bar -->
    <div id="bottom-controls">
        <div class="timeline-main">
            <button id="timeline-prev-btn" class="timeline-nav-btn" title="Previous Map"><i class="fas fa-chevron-left"></i></button>
            <div id="timeline-card-display">
                <!-- The active map card will be injected here by JS -->
            </div>
            <button id="toggle-details-btn" class="timeline-nav-btn" title="Show More Info"><i class="fas fa-chevron-up"></i></button>
            <button id="timeline-next-btn" class="timeline-nav-btn" title="Next Map"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div id="timeline-dots"></div>
    </div>

    <!-- Leaflet JS from CDN -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Placeholder JS files. If you have them, they should be in a 'js' folder. -->
    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/labels.js"></script>

    <script>
    // --- Global Variables ---
    let map; let hash; let autolinker = new Autolinker({ truncate: { length: 30, location: 'smart' } });
    let baseLayers = {}; let currentBaseLayerId = 'google_sat';
    let historicalMapData = []; let sortedMaps = []; let mapLayers = {};
    let currentActiveLayer = null; let currentLang = 'vi';
    let currentCarouselIndex = 0;
    let isTimelineExpanded = false;
    // Use a global opacity setting
    const OPACITY_PRESETS = [1, 0.75, 0.5, 0.25, 0];
    let globalOpacity = 1.0;    
    
    const translations = {
        en: {
            welcomeTitle: "Saigon - HCMC Historical Maps",
            switchLangBtn: "Tiếng Việt", switchLangBtnShort: "VI",
            opacityLabelText: "Opacity:",
            csvError: "Error loading data.", mapLoadError: "Could not load map data."
        },
        vi: {
            welcomeTitle: "Bản đồ Lịch sử Sài Gòn - TP.HCM",
            switchLangBtn: "English", switchLangBtnShort: "EN",
            opacityLabelText: "Độ mờ:",
            csvError: "Lỗi tải dữ liệu.", mapLoadError: "Không thể tải dữ liệu bản đồ."
        }
    };

    // --- DOM Elements ---
    const topBarLanguageBtn = document.getElementById('top-bar-language-btn');
    const bodyElement = document.body;
    const aboutBtn = document.getElementById('about-btn');
    const aboutOverlay = document.getElementById('about-overlay');
    const aboutPopup = document.getElementById('about-popup');
    const closeAboutBtn = document.getElementById('close-about-btn');
    const searchInput = document.getElementById('search-input');
    const searchResultsContainer = document.getElementById('search-results-container');
    const bottomControls = document.getElementById('bottom-controls');
    const timelineDots = document.getElementById('timeline-dots');
    const timelineCardDisplay = document.getElementById('timeline-card-display');
    const timelinePrevBtn = document.getElementById('timeline-prev-btn');
    const timelineNextBtn = document.getElementById('timeline-next-btn');
    const toggleDetailsBtn = document.getElementById('toggle-details-btn');
    const opacityControlContainer = document.getElementById('opacity-control-container');
    const opacityBtn = document.getElementById('opacity-btn');
    const opacityLabel = document.getElementById('opacity-label');

    // --- Core Functions ---
    async function loadCSV(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) { throw new Error(`HTTP error! status: ${response.status} for ${url}`); }
            const csvText = await response.text();
            return new Promise((resolve, reject) => {
                Papa.parse(csvText, {
                    header: true, skipEmptyLines: true,
                    complete: (results) => results.errors.length ? reject(new Error(`CSV parsing error in ${url}`)) : resolve(results.data),
                    error: (error) => reject(error)
                });
            });
        } catch (error) {
            console.error(`Error fetching or parsing CSV from ${url}:`, error);
            alert(`${translations[currentLang]?.csvError || 'Error loading data'} (${url})`);
            throw error;
        }
    }

    function initializeMap() {
        map = L.map('map', { zoomControl: false, scrollWheelZoom: true, attributionControl: false }).setView([10.788510799101314, 106.70392011185946], 12);
        L.control.attribution({ prefix: '<a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a>' }).addTo(map);
        hash = L.Hash ? new L.Hash(map) : null;
        const baseLayerOptions = { minZoom: 1, maxZoom: 28, reuseTiles: true };
        baseLayers['google_map'] = L.tileLayer('https://mt.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { ...baseLayerOptions, attribution: 'Map data © Google', label: 'Google Maps' });
        baseLayers['google_sat'] = L.tileLayer('https://mt.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { ...baseLayerOptions, attribution: 'Imagery © Google', label: 'Google Satellite' });
        baseLayers['osm'] = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { ...baseLayerOptions, attribution: '© OpenStreetMap', label: 'OpenStreetMap' });
        baseLayers['esri_sat'] = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { ...baseLayerOptions, attribution: 'Tiles © Esri', label: 'Esri Satellite' });
        map.addLayer(baseLayers[currentBaseLayerId]);
    }

    function createMapLayers() {
        historicalMapData.forEach(item => {
            const yearNum = parseInt(item.year, 10) || 1800;
            const isTiled = item.url && item.url.includes('{z}');
            const paneId = `pane_${item.id}`;
            map.createPane(paneId).style.zIndex = 200 + (yearNum || 0) - 1700;
            let layer;
            const options = { pane: paneId, attribution: item.attribution || '', customId: item.id, opacity: 1.0 };
            const bounds = [[parseFloat(item.bounds_sw_lat), parseFloat(item.bounds_sw_lng)], [parseFloat(item.bounds_ne_lat), parseFloat(item.bounds_ne_lng)]];
            if (bounds.some(c => c.some(isNaN))) return;

            if (isTiled) {
                layer = L.tileLayer(item.url, { ...options, minZoom: 1, maxZoom: 28, maxNativeZoom: item.maxzoom ? parseInt(item.maxzoom, 10) : 18, tms: item.tms === '1' });
            } else {
                layer = L.imageOverlay(item.url, bounds, { ...options, interactive: false });
            }
            mapLayers[item.id] = { layer: layer, info: item, bounds: bounds };
        });
    }

    function activateLayer(layerId, fitBounds = true) {
        const selectedMap = mapLayers[layerId];
        if (!selectedMap) return;
        if (currentActiveLayer && currentActiveLayer !== selectedMap.layer) {
            if (map.hasLayer(currentActiveLayer)) map.removeLayer(currentActiveLayer);
        }
        if (!map.hasLayer(selectedMap.layer)) map.addLayer(selectedMap.layer);
        currentActiveLayer = selectedMap.layer;

        // Apply the global opacity to the newly activated layer
        if (typeof currentActiveLayer.setOpacity === 'function') {
            currentActiveLayer.setOpacity(globalOpacity);
        }
        // Also store it on the layer's options
        currentActiveLayer.options.opacity = globalOpacity;

        if (fitBounds && selectedMap.bounds) {
             map.flyToBounds(selectedMap.bounds, { padding: [50, 50], duration: 1.2 });
        } else if (selectedMap.bounds) {
            // This logic runs when navigating the timeline (fitBounds is false).
            // It ensures the user isn't zoomed out too far to see the newly selected map.
            const idealZoom = map.getBoundsZoom(selectedMap.bounds);
            if (map.getZoom() < idealZoom) {
                // If we are too zoomed out, fly to a reasonable view of the new layer.
                map.flyTo(L.latLngBounds(selectedMap.bounds).getCenter(), idealZoom, { duration: 1.0 });
            }
        }
    }

    function setLanguage(lang) {
        currentLang = lang;
        document.documentElement.lang = lang;
        document.querySelectorAll('[data-i18n-key]').forEach(el => {
            const key = el.dataset.i18nKey;
            const translation = translations[lang]?.[key];
            if (!translation) return;
            el.textContent = translation;
        });
        updateOpacityLabel();

        document.title = translations[lang]?.welcomeTitle || 'Historical Maps';
        populateTimelineControls();
        showTimelinePoint(currentCarouselIndex);
    }

    function startDiscoveryMode() {
        bodyElement.className = 'discovery-mode';
        if (map) map.scrollWheelZoom.enable();
        map.invalidateSize();
    }

    function showAboutPopup() {
        aboutOverlay.classList.add('visible');
        aboutPopup.classList.add('visible');
    }

    function hideAboutPopup() {
        aboutOverlay.classList.remove('visible');
        aboutPopup.classList.remove('visible');
    }

    function updateOpacityLabel() {
        if (!opacityLabel) return;
        const percentage = Math.round(globalOpacity * 100);
        const labelText = translations[currentLang]?.opacityLabelText || 'Opacity:';
        opacityLabel.textContent = `${labelText} ${percentage}%`;
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // --- Location Search Functions ---
    async function handleLocationSearch() {
        const query = searchInput.value.trim();
        if (query.length < 3) { // Don't search for very short strings
            hideSearchResults();
            return;
        }

        try {
            const fullQuery = `${query}, Ho Chi Minh City`;
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullQuery)}&limit=5`);
            if (!response.ok) throw new Error(`Nominatim API error: ${response.status}`);
            const results = await response.json();
            displayLocationSearchResults(results);
        } catch (error) {
            console.error("Nominatim search error:", error);
            searchResultsContainer.innerHTML = `<div class="search-result-item" style="cursor:default;">Error during search.</div>`;
            searchResultsContainer.style.display = 'block';
        }
    }

    function displayLocationSearchResults(results) {
        searchResultsContainer.innerHTML = '';
        if (results.length === 0) {
            searchResultsContainer.innerHTML = `<div class="search-result-item" style="cursor:default;">No results found.</div>`;
            searchResultsContainer.style.display = 'block';
            return;
        }

        results.forEach(result => {
            if (!result.boundingbox || result.boundingbox.length !== 4) return;

            const resultItem = document.createElement('div');
            resultItem.className = 'search-result-item';
            resultItem.textContent = result.display_name;
            resultItem.addEventListener('mousedown', (e) => {
                e.preventDefault();
                // Fly to the location's center at zoom level 16
                const lat = parseFloat(result.lat);
                const lon = parseFloat(result.lon);
                map.flyTo([lat, lon], 16);
                searchInput.value = '';
                hideSearchResults();
            });
            searchResultsContainer.appendChild(resultItem);
        });

        if (searchResultsContainer.childElementCount > 0) {
            searchResultsContainer.style.display = 'block';
        } else {
            hideSearchResults();
        }
    }

    function hideSearchResults() {
        if (searchResultsContainer) searchResultsContainer.style.display = 'none';
    }

    // --- Timeline Functions ---
    function initializeTimeline() {
        populateTimelineControls();
        timelinePrevBtn.addEventListener('click', () => showTimelinePoint(currentCarouselIndex - 1));
        timelineNextBtn.addEventListener('click', () => showTimelinePoint(currentCarouselIndex + 1));
        showTimelinePoint(0); // Set initial state
    }

    function populateTimelineControls() {
        timelineDots.innerHTML = '';
        sortedMaps.forEach((mapData, index) => {
            const dotItem = document.createElement('div');
            dotItem.className = 'dot-item';
            dotItem.dataset.index = index;
            dotItem.innerHTML = `
                <span class="timeline-dot"></span>
                <span class="dot-year">${mapData.year}</span>
            `;
            dotItem.addEventListener('click', () => showTimelinePoint(index));
            timelineDots.appendChild(dotItem);
        });
    }

    function showTimelinePoint(index) {
        if (index < 0 || index >= sortedMaps.length) return;
        const mapData = sortedMaps[index];
        if (!mapData) return;

        // Update Card Content
        const title = mapData[`name_${currentLang}`] || 'Untitled Map';
        let detail = mapData[`detail_${currentLang}`] || mapData[`info_${currentLang}`] || '';
        const author = mapData[`author_${currentLang}`] ? `<em>${mapData[`author_${currentLang}`]}</em>` : '';
        // Combine author and details into one summary block
        if (detail) {
            detail = autolinker.link(detail.replace(/\n/g, '<br>'));
        }
        const summaryHtml = [author, detail].filter(Boolean).join('<br><br>');

        timelineCardDisplay.innerHTML = `
            <div class="map-card">
                <div class="map-card-header"><span class="map-card-title">${title}</span></div>
                <div class="map-card-summary">${summaryHtml}</div>
            </div>
        `;

        // Update Dots
        const oldDot = timelineDots.querySelector('.dot-item.active');
        if (oldDot) oldDot.classList.remove('active');
        const newDot = timelineDots.children[index];
        if (newDot) {
            newDot.classList.add('active');
            newDot.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }

        // Update Buttons
        timelinePrevBtn.disabled = index <= 0;
        timelineNextBtn.disabled = index >= sortedMaps.length - 1;

        // Update Map Layer
        if (currentActiveLayer?.options.customId !== mapData.id) {
            activateLayer(mapData.id, false); // Changed from true to false to prevent auto-zooming
        }

        // Update State
        currentCarouselIndex = index;
    }

    // --- Initialization ---
    async function initializeApp() {
        const preferredLang = localStorage.getItem('preferredLang');
        if (preferredLang && translations[preferredLang]) currentLang = preferredLang;
        try {
            [historicalMapData] = await Promise.all([
                loadCSV('https://raw.githubusercontent.com/lqtue/historical_maps/main/data/maps.csv')
            ]);
            sortedMaps = historicalMapData.filter(m => m.year && !isNaN(parseInt(m.year, 10))).sort((a, b) => parseInt(a.year) - parseInt(b.year));
            initializeMap();
            createMapLayers();
            initializeTimeline();
            setLanguage(currentLang);
            startDiscoveryMode();
        } catch (error) {
            console.error("Initialization failed:", error);
            document.body.innerHTML = `<div style="padding:20px; text-align:center;"><h1>Application Error</h1><p>Could not load essential data. Please check your internet connection and the browser console for details.</p></div>`;
        }
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', initializeApp); // This should be the only DOMContentLoaded listener
    aboutBtn.addEventListener('click', showAboutPopup);
    closeAboutBtn.addEventListener('click', hideAboutPopup);
    aboutOverlay.addEventListener('click', hideAboutPopup);

    // Location Search listeners
    const debouncedSearch = debounce(handleLocationSearch, 400);
    searchInput.addEventListener('input', debouncedSearch);
    searchInput.addEventListener('focus', handleLocationSearch);
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-container')) {
            hideSearchResults();
        }
    });

    topBarLanguageBtn.addEventListener('click', () => setLanguage(currentLang === 'vi' ? 'en' : 'vi'));
    timelinePrevBtn.addEventListener('click', () => showTimelinePoint(currentCarouselIndex - 1));
    timelineNextBtn.addEventListener('click', () => showTimelinePoint(currentCarouselIndex + 1));
    toggleDetailsBtn.addEventListener('click', () => {
        isTimelineExpanded = !isTimelineExpanded;
        bottomControls.classList.toggle('expanded', isTimelineExpanded);

        const icon = toggleDetailsBtn.querySelector('i');
        if (isTimelineExpanded) {
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
            toggleDetailsBtn.title = "Show Less Info";
        } else {
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
            toggleDetailsBtn.title = "Show More Info";
        }
    });

    // Opacity preset cycle button listener
    opacityBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (!currentActiveLayer) return;

        // Find current preset index from globalOpacity
        let currentOpacityPresetIndex = OPACITY_PRESETS.indexOf(globalOpacity);
        if (currentOpacityPresetIndex === -1) { // If not a perfect match, find closest
            const closest = OPACITY_PRESETS.reduce((prev, curr) => (Math.abs(curr - globalOpacity) < Math.abs(prev - globalOpacity) ? curr : prev));
            currentOpacityPresetIndex = OPACITY_PRESETS.indexOf(closest);
        }

        // Cycle to the next preset index
        const nextPresetIndex = (currentOpacityPresetIndex + 1) % OPACITY_PRESETS.length;
        globalOpacity = OPACITY_PRESETS[nextPresetIndex];

        // Apply new opacity to the layer
        if (typeof currentActiveLayer.setOpacity === 'function') {
            currentActiveLayer.setOpacity(globalOpacity);
        }
        currentActiveLayer.options.opacity = globalOpacity; // Also update layer's option
        updateOpacityLabel();
    });

    </script>
</body>
</html>
